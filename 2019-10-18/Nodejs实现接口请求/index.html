<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>二刺螈小破站</title>
  
  <link rel="alternate" href="/atom.xml" title="小贱客" type="application/atom+xml">
  
  
  <link rel="shortcut icon" href="/images/favicon.png"> 
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1317659_91ay27oeya8.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
  <script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <link rel="stylesheet" href="https://cdn.bootcss.com/animate.css/3.7.2/animate.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="/css/loader.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/myCss.css">
</head></html>

<body>
  <div id="container" class="container-fluid">
    <div id="wrap">
      <!--//头部展示-->
<header>
  <div id="loader-wrapper">
    <div id="loader"></div>
    <div class="loader-section section-left"></div>
    <div class="loader-section section-right"></div>
    <div class="load_title">正在加载二刺螈站点<br><span>V2.1</span></div>
  </div>
  <!--页面背景图-->
  <div class="theme-bg"></div>
  <!--导航栏-->
  <div class="hidden-bar">
    <nav class="navbar">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
            data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="logo">
            <a class="navbar-brand" href="#"><img src="/images/favicon.png"></a>
          </div>
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li><a href="/" title="首页" class="iconfont iconhome">首页</a></li>
            <li><a href="/archives" title="归档" class="iconfont iconbook">归档</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right hidden-xs">
            <li><a id="times" href="#"></a></li>
          </ul>
        </div>
      </div>
    </nav>
  </div>

  <!--//标题-->
  <div class="top-banner">
    <!--//超大屏下显示-->
    <div class="hidden-xs hidden-sm  hidden-md">
      <img src="/images/2233-bask.jpg" style="width: 100%;">
      <div class="ban-title">
        <a class="portrait" href="/">
          <img src="/images/2233&cat.jpg" class="wow slideInDown">
        </a>
        <div class="wow fadeInUp">
          <h1>er 刺螈</h1>
          <p>Welcome to my personal site</p>
        </div>
        <a href="https://github.com/SakuraXIII/SakuraXIII.github.io" title="Github Pages"
          class="iconfont icongithub"></a>
        <a href="https://www.zhihu.com/people/an-ye-yong-heng-45/activities" title="玩知乎嘛"
          class="iconfont iconzhihu1"></a>
        <div class="hitokoto-text  wow flipInX">
          <p class="hitokoto"></p><strong></strong>
        </div>
      </div>
    </div>
    <!--//中屏-->
    <div class="hidden-lg hidden-xs md img">
      <div class="ban-title mdtitle">
        <h1>er刺螈</h1>
        <p>Welcome to my personal site</p>
        <a href="https://github.com/SakuraXIII/SakuraXIII.github.io" class="iconfont icongithub"></a>
        <a href="https://www.zhihu.com/people/an-ye-yong-heng-45/activities" class="iconfont iconzhihu1"></a>
        <div class="hitokoto-text">
          <p class="hitokoto"></p><strong></strong>
        </div>
      </div>
    </div>
    <!--手机上只显示图片，不显示文字-->
    <div class="hidden-lg hidden-md hidden-sm other img">
      <div class="ban-title othertitle">
        <h1>er刺螈</h1>
        <p>Welcome to my personal site</p>
      </div>

    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
          <article id="post-Nodejs实现接口请求" class="wow bounceInLeft article article-type-post" itemscope
  itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019-10-18/Nodejs实现接口请求/" class="article-date">
  <time datetime="2019-10-18T09:57:00.000Z" itemprop="datePublished">2019-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <header class="article-header">
      
  
    <h1 class="article-title" itemprop="name">
      Nodejs实现接口的请求
    </h1>
  

    </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
      
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>自成功实现用Nodejs实现小爬虫后，对Nodejs异常感兴趣，其他的都搁置一边了，正巧又碰到在看的一个前端网课的案例接口不能用了，于是乎决定自己实现那个接口。</p>
<a id="more"></a>

<p><img src="/images/post/Nodejs%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3/8.jpg" alt></p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><h3 id="关于思路"><a href="#关于思路" class="headerlink" title="关于思路"></a>关于思路</h3><p>建好文件夹，初始化后，仍然是先在网上查阅一些相关的博客，了解一下实现接口的思路。看了几个博主的简单案例之后，个人对实现的方法的理解是：通过监视指定接口地址的状态，监测到了接口的请求消息，将消息进行处理，再发送对应的响应给目标浏览器，从而实现数据的请求。</p>
<h3 id="关于实现"><a href="#关于实现" class="headerlink" title="关于实现"></a>关于实现</h3><p><em>由于对数据库的使用不太熟悉，再加上只是一个简单的小练习，所以使用JSON文件存储数据，也没有使用express框架，打算熟悉一下原生的语法</em></p>
<ol>
<li>在入口文件中引入相关的<code>http , fs , url</code>模块，创建一个服务：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">let</span> Url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// 逻辑实现</span></span><br><span class="line">&#125;).listen(<span class="number">5500</span>,()=&gt;&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'connect...'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>服务开启后开始监视对服务的请求了，使用<code>url</code>模块获取请求的对象的相关信息：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = Url.parse(req.url, <span class="literal">true</span>) <span class="comment">//解析URL地址，true参数可将数据解析成对象，方便处理</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>能够接收到请求目标的地址，就可以用来判断请求的是哪个功能的接口地址：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (url.pathname === <span class="string">'/getAllInfo'</span> &amp;&amp; req.method == <span class="string">'GET'</span>) &#123;</span><br><span class="line">     <span class="comment">// some code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>为了程序的可维护性和模块化，可以另创建一个模块用来处理业务逻辑，在入口文件中引入模块。</li>
<li>不要忘记CORS跨域问题，创建服务后开头声明好请求头：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置允许跨域的域名，*代表允许任意域名跨域</span></span><br><span class="line">res.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</span><br><span class="line"><span class="comment">//允许的header类型</span></span><br><span class="line">res.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type,Content-Length, Authorization, Accept,X-Requested-With"</span>);</span><br><span class="line"><span class="comment">//跨域允许的请求方式 </span></span><br><span class="line">res.setHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"PUT,POST,GET,DELETE,OPTIONS"</span>);</span><br></pre></td></tr></table></figure>

<h3 id="关于问题"><a href="#关于问题" class="headerlink" title="关于问题"></a>关于问题</h3><ul>
<li><p>关于文件数据的获取</p>
<p>获取文件数据响应给浏览器时，在业务逻辑模块的router文件中读取到json文件的数据，一开始想用return返回到入口文件，用另一个变量接收，然后打印在控制台，结果发现为<code>undefine</code>，经过各种尝试均无用。后来突然想起来了这个问题就是用回调函数来解决的。后来根据个人猜想加上网上查证得知，读取文件的<code>readFile()</code>方法是<code>异步非阻塞的</code>，所以入口文件无法接收到数据。可以使用<code>readFileSync()</code>方法，这是<code>同步阻塞的</code>。</p>
</li>
<li><p>POST请求</p>
<ul>
<li><p>数据的获取</p>
<p>本案例的POST请求实现的功能是将浏览器请求时附带的数据存储到文件中，由于POST请求无法通过URL附带参数获取，所以需要用<code>res.on(&#39;data&#39;，callback)</code>获取：</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str = <span class="string">''</span>;</span><br><span class="line">req.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">  <span class="comment">//当有数据时触发'data'时间</span></span><br><span class="line">  str += chunk;</span><br><span class="line">&#125;)</span><br><span class="line">req.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line"><span class="comment">//当数据接收完成，没有数据时，触发'end'事件</span></span><br><span class="line">  <span class="comment">//在这里实现功能</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
<ul>
<li><p>405</p>
<p>在进行功能测试时，发现提交数据后控制台就报错405，连接被重置，在网上也没有找到解决办法，最后试了一下在最后加上<code>res.end(&#39;finish&#39;)</code>，居然就好了。猜测应该是因为TCP连接的机制导致的，浏览器在请求地址时，服务器接收到数据了，却没有给出答复，浏览器误以为没有连接成功，就重置了。所以每次进行请求时，服务器都要给出响应信息。</p>
</li>
</ul>
<ul>
<li><p>编码</p>
<p>在检查添加进文件中的数据时，发现中文全部乱码了，以为是没有指定UTF-8编码，加上也没用，在浏览器控制台里检查请求头信息，发现POST发送的数据是以Form Data形式，被编码<code>(encodeURIComponent)</code>成了URI，对此不甚了解，在去查了一下，得知需要将URI解码，所以在代码中要把接收的数据解码<code>str = decodeURIComponent(str)</code>。</p>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最后这个简单的API就完成了，不外乎就是增删查改，顺便放在了服务器上跑着玩。虽然第一次写这个，还没感觉到什么难度，但是也同样遇到了这么多的问题，也是收获不少，重点是要学会面向百度编程（滑稽），以及多看文档，勤加练习，遇到更多的问题，才能有更多的经验。</p>

      
      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/笔记/">笔记</a></li></ul>

    </footer>
  </div>
  
  
<nav id="article-nav">
  
    <a href="/2019-11-08/exceljs的使用（一）/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          exceljs操作Excel（一）
        
      </div>
    </a>
  
  
    <a href="/2019-10-13/阿里云服务器初体验/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">阿里云服务器初体验</div>
    </a>
  
</nav>

  
</article>


          
          <div id="lv-container" class="commentModel" data-id="city" data-uid="MTAyMC80ODM2Ni8yNDg2MA=="></div>
          
        </section>
        
        <aside id="sidebar" class="hidden-xs wow bounceInRight">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/教程/">教程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日志/">日志</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日记/">日记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/笔记/">笔记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020-01-30/pywifi使用/">(no title)</a>
          </li>
        
          <li>
            <a href="/2020-01-22/回顾2019及博客的更新日志/">回顾2019及博客的更新日志</a>
          </li>
        
          <li>
            <a href="/2019-11-14/博客全面更新/">博客全面更新及教程</a>
          </li>
        
          <li>
            <a href="/2019-11-10/js中的引用类型/">js中的引用类型</a>
          </li>
        
          <li>
            <a href="/2019-11-09/exceljs的使用（三）/">exceljs操作Excel（三）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Sakura Sun<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
  <img src="/images/2233&sleep.png" style="position: fixed;bottom: 0;right: 0;width: 15%;">
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
    <div class="live2d hidden-xs hidden-sm">
      <link rel="stylesheet" href="/js/live2d/waifu.css">
      <script src="/js/live2d/live2d.js"></script>
      <script src="/js/live2d/waifu-tips.js"></script>
      <!-- // live2d -->
      <div class="waifu">
        <div class="waifu-tips"></div>
        <canvas id="live2d" class="live2d"></canvas>
        <div class="waifu-tool">
          <span class="fui-home"></span>
          <span class="fui-chat"></span>
          <span class="fui-eye"></span>
          <span class="fui-user"></span>
          <span class="fui-photo"></span>
          <span class="fui-info-circle"></span>
          <span class="fui-cross"></span>
        </div>
      </div>
      <script type="text/javascript">
        live2d_settings['modelId'] = 4;
        live2d_settings['modelTexturesId'] = 87;
        initModel("/js/live2d/waifu-tips.json")
      </script>
    </div>
    <div class="player hidden-xs hidden-sm">
      <!-- //网易云播放器 -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.0/dist/APlayer.min.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script>
      <div id="aplayer" class="aplayer" data-id="2127198653" data-server="netease" data-type="playlist"
        data-fixed="true" data-listfolded="true" data-order="random" data-theme="#F58EA8"></div>
      <script src="https://unpkg.com/meting@1.2/dist/Meting.min.js"></script>
    </div>
  </div>
  <script src="https://cdn.bootcss.com/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.bootcss.com/wow/1.1.2/wow.min.js"></script>
  <!-- <script src="/js/snow.js"></script> -->
  <script src="/js/style.js"></script>
  <script type="text/javascript">
    // 等待所有加载
    $(window).load(function () {
      $('body').addClass('loaded');
      $('#loader-wrapper .load_title').remove();
    });
  </script>
  <!-- 来必力City版安装代码 -->
  <script type="text/javascript">
    (function (d, s) {
      var j, e = d.getElementsByTagName(s)[0];

      if (typeof LivereTower === 'function') {
        return;
      }

      j = d.createElement(s);
      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
      j.async = true;

      e.parentNode.insertBefore(j, e);
    })(document, 'script');
  </script>
  <!-- City版安装代码已完成 -->
</body>

</html>