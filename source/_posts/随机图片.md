---
title: 要来一张图片嘛？
date: 2020-03-29 13:24:00
tags: [二次元,nodejs]
category: 随便写写
---

也许你也发现了博客背景是随机变化的了。之前在逛博客的时候，发现有些博客的图片是随机刷新的，本以为是在浏览器端实现的，自己尝试了一下，经过一番浪费时间的瞎折腾，终于还是失败了。

<!--more-->

后来又在某些大佬的博客中找到了他们提供的API，给谷歌浏览器，Typora，博客加上之后看着真是赏心悦目。于是就用了很久。

![](/images/pic/71.jpg)

## 原因

在前段时间，一直在用的API还是失效了，需要联系[大佬](https://acg.blue/)加入白名单。换上备用的API😂后，意识到白嫖终究不是长久之计，决定自给自足。

## 开始

既然是服务端程序，自然就需要一个服务器，所幸之前参加了阿里云的活动，有一台服务器留着一直没用，这次就拿来用一下。即使没有服务器，用阿里云提供的函数计算服务也是可以的，根据这个程序实际上的请求量来看，一个月一块钱不到吧。

其次我们需要的就是图片了，可以把图片放在图床，一开始我是把图片都放在服务器里的一个目录下，后来发现访问速度太慢了，就直接把图片存放在博客仓库的目录下，然后通过码云提供的 API 获取仓库数据。

### 分析

这个程序主要是通过监听端口，得到请求地址后，获取图片列表，随机返回一张图片。我们可以通过返回图片所在的路径地址来减小发送的数据，降低服务器压力，提高效率。由于我们获取的图片是用来做背景图片的，所以更好的办法是直接重定向到图片地址，无需返回图片路径。

### 实现

#### 1.读取目录获取图片

`fs.readdir(path[, options], callback)` ，该方法可以异步的读取目录的内容，回调函数接收 (err,files) 两个参数。`options` 可以指定 `encoding` 编码，默认 `utf8` 。通过这个方法，我们就可以得到所有的图片的名字。

#### 2.码云API获取图片

实际上我是通过这种方法来获取图片的，无论是使用图床还是码云仓库，都是为了减轻个人服务器的压力，~主要是带宽不够╮(╯-╰)╭~。但是图片的目录必须放在博客的分支下，这样才能够通过博客地址加相对路径访问到图片。

在[码云API](https://gitee.com/api/v5/swagger#/getV5ReposOwnerRepoStargazers?ex=no)中，`仓库` 下有 `获取仓库具体路径下的内容` 这个API，使用前我们需要获取 `AccessToken` ，但是只有一天有效期，需要通过回调函数重新获取，具体的可以看文档。这种方法如此麻烦，主要是用于第三方应用的。在个人账号的 `设置` 中可以发现一个 `私人令牌` 的选项，我们可以申请一个新令牌，设置好权限，最终就会生成一个 `Token` ，这种方法更适用于个人开发。

 *`API格式：(https://gitee.com/api/v5/repos/{仓库所属空间地址}/{repoName}/contents/{dirPath}?access_token={Token}&ref={?branchName})`* 。

通过 `http.request` GET请求后会返回一系列字段， `path` 才是我们需要的图片相对仓库的路径。如果存放的图片很多，就需要进行字符拼接了(否则数据显示不全)。

```javascript
const req =	https.request(url, res => {
  res.setEncoding("utf8"); 
  let data = "";
	res.on("data", d => {
    data += d; // 进行数据拼接
  });
  res.on("end", () => {
    console.log(data);
  });
});       
req.on("error", e => {       
  console.error(e);     
});    
req.end();
```

#### 3.重定向

最后我们只需要将博客地址拼接上获取的随机图片的相对路径，这就是重定向后的URL地址。

```javascript
res.writeHead(302, {
  Location: "https://yourblog.gitee.io/" + imgPath
});
```

#### 4.优化

为了提高效率，减少请求API的次数，我们可以将码云返回的数据存到一个全局数组中，每次直接从数组中获取图片路径。隔一段时间再去更新。代码地址：https://gitee.com/Tonyteachers/randomPic

